#include <fstream>
#include <iostream>
#include <vector>
#include <cmath>

const unsigned int FLEN = 201;

float FILT[201] = {-0.000010, 
-0.000016, 
-0.000023, 
-0.000032, 
-0.000043, 
-0.000055, 
-0.000068, 
-0.000084, 
-0.000101, 
-0.000121, 
-0.000142, 
-0.000166, 
-0.000192, 
-0.000220, 
-0.000250, 
-0.000282, 
-0.000316, 
-0.000353, 
-0.000391, 
-0.000431, 
-0.000473, 
-0.000517, 
-0.000562, 
-0.000609, 
-0.000657, 
-0.000705, 
-0.000755, 
-0.000805, 
-0.000855, 
-0.000905, 
-0.000955, 
-0.001004, 
-0.001053, 
-0.001100, 
-0.001145, 
-0.001189, 
-0.001230, 
-0.001268, 
-0.001304, 
-0.001336, 
-0.001364, 
-0.001388, 
-0.001408, 
-0.001422, 
-0.001432, 
-0.001436, 
-0.001435, 
-0.001427, 
-0.001413, 
-0.001393, 
-0.001366, 
-0.001332, 
-0.001290, 
-0.001242, 
-0.001186, 
-0.001123, 
-0.001052, 
-0.000974, 
-0.000889, 
-0.000796, 
-0.000696, 
-0.000590, 
-0.000476, 
-0.000356, 
-0.000230, 
-0.000098, 
0.000040, 
0.000183, 
0.000330, 
0.000482, 
0.000638, 
0.000797, 
0.000959, 
0.001123, 
0.001289, 
0.001455, 
0.001622, 
0.001789, 
0.001955, 
0.002119, 
0.002281, 
0.002440, 
0.002595, 
0.002747, 
0.002893, 
0.003035, 
0.003170, 
0.003299, 
0.003420, 
0.003534, 
0.003640, 
0.003737, 
0.003825, 
0.003903, 
0.003972, 
0.004031, 
0.004080, 
0.004118, 
0.004145, 
0.004161, 
0.004167, 
0.004161, 
0.004145, 
0.004118, 
0.004080, 
0.004031, 
0.003972, 
0.003903, 
0.003825, 
0.003737, 
0.003640, 
0.003534, 
0.003420, 
0.003299, 
0.003170, 
0.003035, 
0.002893, 
0.002747, 
0.002595, 
0.002440, 
0.002281, 
0.002119, 
0.001955, 
0.001789, 
0.001622, 
0.001455, 
0.001289, 
0.001123, 
0.000959, 
0.000797, 
0.000638, 
0.000482, 
0.000330, 
0.000183, 
0.000040, 
-0.000098, 
-0.000230, 
-0.000356, 
-0.000476, 
-0.000590, 
-0.000696, 
-0.000796, 
-0.000889, 
-0.000974, 
-0.001052, 
-0.001123, 
-0.001186, 
-0.001242, 
-0.001290, 
-0.001332, 
-0.001366, 
-0.001393, 
-0.001413, 
-0.001427, 
-0.001435, 
-0.001436, 
-0.001432, 
-0.001422, 
-0.001408, 
-0.001388, 
-0.001364, 
-0.001336, 
-0.001304, 
-0.001268, 
-0.001230, 
-0.001189, 
-0.001145, 
-0.001100, 
-0.001053, 
-0.001004, 
-0.000955, 
-0.000905, 
-0.000855, 
-0.000805, 
-0.000755, 
-0.000705, 
-0.000657, 
-0.000609, 
-0.000562, 
-0.000517, 
-0.000473, 
-0.000431, 
-0.000391, 
-0.000353, 
-0.000316, 
-0.000282, 
-0.000250, 
-0.000220, 
-0.000192, 
-0.000166, 
-0.000142, 
-0.000121, 
-0.000101, 
-0.000084, 
-0.000068, 
-0.000055, 
-0.000043, 
-0.000032, 
-0.000023, 
-0.000016, 
-0.000010};

int main(int argc, char* argv[]){
	unsigned int NSAMP = 24000;
	unsigned int NCHAN = 128;
	unsigned int LEN = NSAMP * NCHAN;
	unsigned int FSLEN = (NSAMP-FLEN) * NCHAN;
	unsigned int MULT = 1 << 14;

	std::vector<short> sig;
	std::vector<short> fsig;
	std::vector<double> fsum;
	std::vector<long> fsumlong;

	sig.resize(LEN);
	fsig.resize(LEN);
	fsum.resize(NCHAN);
	fsumlong.resize(NCHAN);

	std::cout << "Open " << argv[1] << "\n";
	std::cout.flush();

	std::ifstream fin(argv[1], std::ios::binary);
	std::ofstream fout(argv[2], std::ios::binary);

	std::vector<int> FILTINT;
	for (unsigned int f=0; f < FLEN; ++f){
		FILTINT.push_back(int(FILT[f] * MULT));
	}

	const unsigned int fstep = 20;
	const unsigned int sstep = 2;

	while (!fin.eof()){
		unsigned int fsigpos = 0;
		fin.read((char*)&sig[0], sizeof(short) * LEN);
		for (unsigned int s=0; s < NSAMP-FLEN; s += sstep){
			//std::fill(fsum.begin(), fsum.end(), 0);
			std::fill(fsumlong.begin(), fsumlong.end(), 0);
			int *fptr = &FILTINT[0];
			short *sigptr = &sig[s * NCHAN];
			for (unsigned int f=0; f < FLEN; f += fstep, fptr += fstep){
				sigptr += (fstep - 1) * NCHAN;
				for (unsigned int c = 0; c < NCHAN; ++c, sigptr ++){
					//fsum[c] += FILT[f] * sig[s*NCHAN + NCHAN*f + c];
					fsumlong[c] += (* fptr) * (* sigptr);
				}
			}

			for (unsigned int c = 0; c < NCHAN; ++c){
				//fsig[fsigpos + c] = fsum[c];
				fsig[fsigpos + c] = std::abs(fsumlong[c] >> 14) * fstep;
			}
			fsigpos += NCHAN;
		}
		fout.write((char*)&fsig[0], sizeof(short) * FSLEN / sstep);
	}

//	for (int i=0; i< NSAMP; ++i){
//		std::cout << sig[i * NCHAN] << " ";
//	}

	return 0;
}
